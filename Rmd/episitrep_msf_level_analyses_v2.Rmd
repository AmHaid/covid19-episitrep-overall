---
title: "Covid-19 EpiSitrep MSF data analysis"
description: |
  This document presents tables, graphs and maps of the MSF Covid-19 linelists analyses (not much text). Most, but not all, of these analyses are presented and commented in the MSF Intersection Covid-19 EpiSitrep edited by Epicentre (for information on the EpiSitrep, please contact Anais.BROBAN@epicentre.msf.org).    
  
  The R scripts for both worldwide and MSF linelist analyses are provided on the following Github repository https://github.com/epicentre-msf/covid19-episitrep-overall for epidemiologists in MSF to use (R skills required). The scripts will be updated from week to week as analysis progresses as requested. 
author:
  - name: Francesco Grandesso
    url: mailto:francesco.GRANDESSO@epicentre.msf.org
    affiliation: Epicentre
    affiliation_url: https://epicentre.msf.org/
  - name: Paul Campbell
    url: mailto:paul.CAMPBELLepicentre.msf.org
    affiliation: Epicentre
    affiliation_url: https://epicentre.msf.org/
date: '`r Sys.Date()`'
output:
  distill::distill_article:
    toc: TRUE
    toc_depth: 1
editor_options:
  chunk_output_type: console
---


<!-- Setup and uploading functions -->
```{r setup, warning = FALSE, message = FALSE, include = FALSE}
if (!exists('path.root')) {
  source(here::here('R', 'setup.r'), encoding = 'UTF-8')
}

source(file.path(path.R, "utils_management.R"), encoding = "UTF-8")
source(file.path(path.R, "utils_vis.R")       , encoding = "UTF-8")
source(file.path(path.R, "set_time_frame.R")  , encoding = "UTF-8")

knitr::opts_chunk$set(cache = FALSE,
                      echo = FALSE,
                      tidy = TRUE,
                      collapse = TRUE,
                      dpi = 150,
                      fig.width = 8,
                      fig.height = 5,
                      fig.align = "center",
                      warning = FALSE,
                      message = FALSE,
                      encoding = "UTF-8")

```

<!-- Import and manage data -->
```{r get_data, include = FALSE}

# The list of countries
df_countries <- readRDS(file.path(path.data, 'df_countries.RDS'))

# The MSF linelist
update_msf_data_anyways <- TRUE

get_updated_msf_data <- ifelse(isTRUE(update_msf_data_anyways) |
                                 !file.exists(file.path(path.local.msf.data, 'dta_MSF.RData')),
                               TRUE,
                               FALSE)

source(file.path(path.R, 'run_get_msf_data.R'), encoding = 'UTF-8')

```



# Overview
This section will present **Information of completeness of data** (number of MSF projects that are active on Covid19 care, reporting individual data (linelist), reporting aggregated data and not reporting data). Number of projects will be listed by continent and region. 
The required data are not available yet. And this section will be updated as soon as they are available.

<!-- **Information** of completeness of data (number of MSF projects that are active on Covid19 care, reporting individual data (linelist), reporting aggregated data and not reporting data). Number of projects will be listed by continent and region.-->
```{r, eval = FALSE}
# This will be a summary table
# We still not have the necessary information to produce this table
```


<!-- **Table** of total number of patients screened, by sex and age group-->
```{r, eval = FALSE}
# Also fo this table we do not have the necessary data yet
```



<!-- Some text outputs for the EpiSitrep --> 
```{r, include = FALSE}

nb_msf_sites_linelist <- length(unique(dta$site_name))
nb_msf_sites_aggregated <- length(unique(dta_aggregated$site_name))
nb_msf_sites <- nb_msf_sites_linelist + nb_msf_sites_aggregated

call_msf_countries <- unique(c(unique(dta$country), unique(dta_aggregated$country)))

nb_msf_obs       <- dta %>% count() %>% pull(n)
nb_msf_confirmed <- sum(dta$covid_status == 'Confirmed', na.rm = TRUE)
nb_msf_probable  <- sum(dta$covid_status == 'Probable' , na.rm = TRUE)
nb_msf_suspected <- sum(dta$covid_status == 'Suspected', na.rm = TRUE)

```

**Number of MSF sites**: `r nb_msf_sites` (`r nb_msf_sites_linelist` sites with linelist data and `r nb_msf_sites_aggregated` with aggreagated data). 

**Total patients consulted/admitted**: `r nb_msf_obs` in `r length(call_msf_countries)` countries (`r combine_words(call_msf_countries)`). 

Of all consultations/admissions patients were: 

  - `r nb_msf_confirmed` confirmed
  - `r nb_msf_probable` probable
  - `r nb_msf_suspected` suspected



# Analysis on all patients consulted/admitted

This section provides an overview of **all patients that attended an MSF supported Covid-19 health facility**: number of patients consulted, but not admitted and number of consulted and admitted to the health facility.

Other results are presented by Covid status (confirmed, probable, suspected, not a case and unknown) and listed by country country or site. 


### Weekly number of consultation and admissions

<!-- Histogram OVERALL of number of consultation/admissions -->
```{r HistConsultationsAdmissions, fig.cap = paste('Weekly number of consultations and admissions in an MSF supported COvid-19 health service as of', format(date_max_report, "%d %B %Y"))}
# DONE by Paul

df_epicurve <- dta %>%
  count(epi_week_consultation, admit) %>%
  drop_na() %>%
  mutate(admit = recode(admit, "Yes" = "Admitted", "No" = "Not Admitted"))

df_admit_prop <- dta %>%
  drop_na(epi_week_consultation) %>%
  group_by(epi_week_consultation) %>%
  summarise(
    total = sum(admit %in% c("Yes", "No")),
    admitted = sum(admit == "Yes"),
    admit_prop = admitted / total
  ) %>%
  ungroup()

n_max <- max(df_admit_prop$total, na.rm = TRUE)
cfr_max <- rounder(max(df_admit_prop$admit_prop, na.rm = TRUE), .1)
cfr_max <- ifelse(cfr_max > 1, 1, cfr_max)
scaling_factor <- cfr_max / n_max # sets the y limit of CFR rounded up to nearest 10% above cfr max

missing_consultation <- sum(is.na(dta$epi_week_consultation))

p_epicurve_consult_admit <- ggplot(df_epicurve, aes(epi_week_consultation, n)) +
  geom_col(aes(fill = admit)) +
  geom_line(data = df_admit_prop,
            aes(y = admit_prop / scaling_factor, colour = "Admitted %"),
            key_glyph = "timeseries", size = 1) +
  ggthemes::scale_fill_tableau(name = "Consultation") +
  scale_x_date(name = "Week of Consultation", date_breaks = "1 week", date_labels = "%V", sec.axis = ggplot2::sec_axis(trans = ~ .)) +
  scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . * scaling_factor, name = "Admitted", labels = scales::percent_format(accuracy = 1))) +
  labs(y = "Patients", colour = NULL, caption = glue::glue("Missing Consultation Dates: {missing_consultation}")) + 
  theme_light() + 
  theme(legend.position = "top")

ggsave(file.path(path.local.msf.graphs, glue("msf_epicurve_consult_admit_{week_report}.png")),
       plot = p_epicurve_consult_admit,
       scale = 1.1,
       dpi = 320)


p_epicurve_consult_admit

```


<!-- Histogram BY CONTINENT of number of consultation/admissions -->
```{r HistConsultationsAdmissionsContinent, fig.cap = paste('Weekly number of consultations and admissions in an MSF supported COvid-19 health service by continent as of', format(date_max_report, "%d %B %Y"))}
# DONE by Paul

df_epicurve_continent <- dta %>%
  count(continent, epi_week_consultation, admit) %>%
  drop_na() %>%
  mutate(admit = recode(admit, "Yes" = "Admitted", "No" = "Not Admitted"))

df_admit_prop_continent <- dta %>%
  drop_na(epi_week_consultation) %>%
  group_by(continent, epi_week_consultation) %>%
  summarise(
    total = sum(admit %in% c("Yes", "No")),
    admitted = sum(admit == "Yes"),
    admit_prop = admitted / total
  ) %>%
  ungroup()

n_max <- max(df_admit_prop_continent$total, na.rm = TRUE)
cfr_max <- rounder(max(df_admit_prop_continent$admit_prop, na.rm = TRUE), .1)
cfr_max <- ifelse(cfr_max > 1, 1, cfr_max)
scaling_factor <- cfr_max / n_max # sets the y limit of CFR rounded up to nearest 10% above cfr max

missing_consultation <- sum(is.na(dta$epi_week_consultation))

p_epicurve_consult_admit_continent <- ggplot(df_epicurve_continent, aes(epi_week_consultation, n)) +
  facet_wrap(~continent) +
  geom_col(aes(fill = admit)) +
  geom_line(data = df_admit_prop_continent,
            aes(y = admit_prop / scaling_factor, colour = "Admitted %"),
            key_glyph = "timeseries", size = 1) +
  ggthemes::scale_fill_tableau(name = "Consultation") +
  scale_x_date(name = "Week of Consultation", date_breaks = "1 week", date_labels = "%V", sec.axis = ggplot2::sec_axis(trans = ~ .), guide = ggplot2::guide_axis(n.dodge = 2)) +
  scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . * scaling_factor, name = "Admitted", labels = scales::percent_format(accuracy = 1))) +
  labs(y = "Patients", colour = NULL, caption = glue::glue("Missing Consultation Dates: {missing_consultation}")) + 
    theme_light() + 
  theme(legend.position = "top")

ggsave(file.path(path.local.msf.graphs, glue("msf_epicurve_consult_admit_continent_{week_report}.png")),
       plot = p_epicurve_consult_admit_continent,
       scale = 1.1,
       dpi = 320)


p_epicurve_consult_admit_continent

```



### Weekly number of Consultations (including admission) by Covid status

<!-- Histogram OVERALL of number of consultation/admissions -->
```{r HistConsultationByCovidStatus, fig.cap = 'Weekly number of consultations (including admission) by Covid status'}
# DONE by Paul

p_epicurve_status <- dta %>%
  count(covid_status, epi_week_consultation) %>%
  ggplot(aes(epi_week_consultation, n, fill = covid_status)) +
  geom_col() +
  ggthemes::scale_fill_tableau(name = "Status") +
  scale_x_date(name = "Week of Consultation", date_breaks = "1 week", date_labels = "%V",
               sec.axis = ggplot2::sec_axis(trans = ~ as.Date(.), labels = function(x) format(x, "%b-%Y"))) +
  labs(y = "Patients") + 
    theme_light() + 
  theme(legend.position = 'top')

ggsave(file.path(path.local.msf.graphs, glue("msf_epicurve_status_{week_report}.png")),
       plot = p_epicurve_status,
       scale = 1,
       dpi = 320)


p_epicurve_status

```


<!-- Histogram BY CONTINENT of number of consultation/admissions -->
```{r HistConsultationByCovidStatusContinent, fig.cap = 'Weekly number of consultations (including admission) by Covid status, in each continent where MSF is operating'}
# DONE by Francesco (copied from the Paul graph just above)

p_epicurve_status_continent <- dta %>%
  count(continent, covid_status, epi_week_consultation) %>%
  ggplot(aes(epi_week_consultation, n, fill = covid_status)) +
  facet_wrap(vars(continent)) +
  geom_col() +
  ggthemes::scale_fill_tableau(name = "Status") +
  scale_x_date(name = "Week of Consultation", date_breaks = "1 week", date_labels = "%V", guide = ggplot2::guide_axis(n.dodge = 2),
               sec.axis = ggplot2::sec_axis(trans = ~ as.Date(.), labels = function(x) format(x, "%b-%Y"))) +
  labs(y = "Patients") +
  theme_light() +
  theme(legend.position = 'top')

ggsave(file.path(path.local.msf.graphs, glue('msf_epicurve_status_continent_{week_report}.png')),
       plot = p_epicurve_status_continent,
       scale = 1,
       dpi = 320)


p_epicurve_status_continent

```



### Summary tables of patients consulted/admitted to an MSF supported COvid-19 health facility 

<!-- 
 === SUMMARY TABLE BY COUNTRY === 
Counts of patients consulted/admitted to an MSF supported health facility by Covid status (confirmed, probable, suspected, not a case and unknown) listed by country
-->
```{r, TblCovidStatusCountry, layout = "l-body-outset"}
# DONE by Francesco

tbl_countries_covid_status <- dta %>%
  select(continent, country, site_name, covid_status) %>%
  add_row(dta_expanded) %>%
  group_by(continent, country) %>%
  summarise(
    total = n(),
    confirmed_n = sum(covid_status == 'Confirmed'),
    probable_n  = sum(covid_status == 'Probable'),
    suspected_n = sum(covid_status == 'Suspected'),
    not_case_n  = sum(covid_status == 'Not a case'),
    unknown_n   = sum(covid_status == 'Unknown'),
    confirmed_p = confirmed_n / total,
    probable_p  = probable_n  / total,
    suspected_p = suspected_n / total,
    not_case_p  = not_case_n  / total,
    unknown_p   = unknown_n   / total) %>%
  ungroup() %>%
  arrange(continent, country)

tbl_countries_dates <- dta %>%
  select(continent, country, site_name, date_consultation) %>%
  add_row(dta_expanded_dates %>% select(-type_date)) %>%
  group_by(country) %>%
  summarise(
    date_adm_first = format(min(date_consultation, na.rm = TRUE), '%d-%m-%Y'),
    date_adm_last  = format(max(date_consultation, na.rm = TRUE), '%d-%m-%Y'))

gtbl_countries_covid_status <- tbl_countries_covid_status %>%
  left_join(tbl_countries_dates) %>%
  gt(rowname_col = "country",
     groupname_col = "continent") %>%
  cols_label(
    country     = 'Country',
    total       = 'Total',
    confirmed_n = 'n',
    probable_n  = 'n',
    suspected_n = 'n',
    not_case_n  = 'n',
    unknown_n   = 'n',
    confirmed_p = '(%)',
    probable_p  = '(%)',
    suspected_p = '(%)',
    not_case_p  = '(%)',
    unknown_p   = '(%)',
    date_adm_first = 'First',
    date_adm_last  = 'Last') %>%
  tab_spanner(
    label = html('Dates of<br>consultation/hospitalisation'),
    columns = vars(date_adm_first, date_adm_last)) %>%
  tab_spanner(
    label = html('Confirmed'),
    columns = starts_with('confirmed_')) %>%
  tab_spanner(
    label = html('Probable'),
    columns = starts_with('probable_')) %>%
    tab_spanner(
    label = html('Suspected'),
    columns = starts_with('suspected_')) %>%
    tab_spanner(
    label = html('Not a case'),
    columns = starts_with('not_case_')) %>%
  tab_spanner(
    label = html('(Unknown)'),
    columns = starts_with('unknown_')) %>%
  fmt_number(
    columns = ends_with('_p'),
    decimals = 1,
    scale_by = 100,
    pattern = "({x})") %>%
  fmt_missing(
    columns = starts_with('date_adm_'),
    missing_text = "Unknown") %>%
  cols_align(
    align = 'right',
    columns = vars(total)) %>%
  cols_align(
    align = 'left',
    columns = ends_with('_p')) %>%
  cols_align(
    align = 'center',
    columns = starts_with('date_adm_')) %>%
  tab_style(
    style = list(
      cell_text(align = "left")),
    locations = cells_column_labels(columns = ends_with('_p'))) %>%
  summary_rows(
    groups = TRUE,
    columns = vars(total, confirmed_n, probable_n, suspected_n, not_case_n, unknown_n),
    fns = list('Country Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>%
  grand_summary_rows(
    columns = vars(total, confirmed_n, probable_n, suspected_n, not_case_n, unknown_n),
    fns = list('Grand Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    grand_summary_row.text_transform = 'uppercase',
    data_row.padding = px(1),
    row_group.padding = px(1),
    summary_row.padding = px(1),
    grand_summary_row.padding = px(1))

gtsave(gtbl_countries_covid_status,
       file.path(path.local.msf.tables, paste0('gtbl_countries_covid_status', '_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_countries_covid_status,
       file.path(path.local.msf.tables, paste0(week_report, '_SUMMARY-TABLE_MSF-countries_by_patients_Covid-status.html'))) %>%
  invisible()


gtbl_countries_covid_status %>% 
  tab_header(
    title = html(paste('SUMMARY TABLE<br>
                 Counts of patients consulted/admitted to an MSF supported COvid-19 health service by Covid status listed by country as of', format(date_max_report, "%d %b %Y"))),
    subtitle = 'Sites with (*) reported aggregated data')

```


<!-- 
 === SUMMARY TABLE BY SITE === 
Counts of patients consulted/admitted to an MSF supported health facility by Covid status (confirmed, probable, suspected, not a case and unknown) 
-->
```{r TblCovidStatusSite, layout = "l-body-outset"}
# DONE by Francesco

tbl_sites_covid_status <- dta %>%
  select(continent, country, site_name, covid_status) %>%
  add_row(dta_expanded %>% mutate(country = gsub(" \\(\\*\\)", "", country))) %>%
  group_by(country, site_name) %>%
  summarise(
    total = n(),
    confirmed_n = sum(covid_status == 'Confirmed'),
    probable_n  = sum(covid_status == 'Probable'),
    suspected_n = sum(covid_status == 'Suspected'),
    not_case_n  = sum(covid_status == 'Not a case'),
    unknown_n   = sum(covid_status == 'Unknown'),
    confirmed_p = confirmed_n / total,
    probable_p  = probable_n  / total,
    suspected_p = suspected_n / total,
    not_case_p  = not_case_n  / total,
    unknown_p   = unknown_n   / total) %>%
  ungroup()

tbl_site_dates <- dta %>%
  select(continent, country, site_name, date_consultation) %>%
  add_row(dta_expanded_dates %>% select(-type_date)) %>%
  group_by(site_name) %>%
  summarise(
    date_adm_first = format(min(date_consultation, na.rm = TRUE), '%d-%m-%Y'),
    date_adm_last  = format(max(date_consultation, na.rm = TRUE), '%d-%m-%Y'))

gtbl_sites_covid_status <- tbl_sites_covid_status %>%
  left_join(tbl_site_dates, by = 'site_name') %>%
  gt(rowname_col = "site_name",
     groupname_col = "country") %>%
  cols_label(
    site_name   = 'Site',
    total       = 'Total',
    confirmed_n = 'n',
    probable_n  = 'n',
    suspected_n = 'n',
    not_case_n  = 'n',
    unknown_n   = 'n',
    confirmed_p = '(%)',
    probable_p  = '(%)',
    suspected_p = '(%)',
    not_case_p  = '(%)',
    unknown_p   = '(%)',
    date_adm_first = 'First',
    date_adm_last  = 'Last') %>%
  tab_spanner(
    label = html('Dates of<br>consultation/hospitalisation'),
    columns = vars(date_adm_first, date_adm_last)) %>%
  tab_spanner(
    label = html('Confirmed'),
    columns = starts_with('confirmed_')) %>%
  tab_spanner(
    label = html('Probable'),
    columns = starts_with('probable_')) %>%
    tab_spanner(
    label = html('Suspected'),
    columns = starts_with('suspected_')) %>%
    tab_spanner(
    label = html('Not a case'),
    columns = starts_with('not_case_')) %>%
  tab_spanner(
    label = html('(Unknown)'),
    columns = starts_with('unknown_')) %>%
  fmt_number(
    columns = ends_with('_p'),
    decimals = 1,
    scale_by = 100,
    pattern = "({x})") %>%
  fmt_missing(
    columns = starts_with('date_adm_'),
    missing_text = "Unknown") %>%
  cols_align(
    align = 'right',
    columns = vars(total)) %>%
  cols_align(
    align = 'left',
    columns = ends_with('_p')) %>%
  cols_align(
    align = 'center',
    columns = starts_with('date_adm_')) %>%
  tab_style(
    style = list(
      cell_text(align = "left")),
    locations = cells_column_labels(columns = ends_with('_p'))) %>%
  summary_rows(
    groups = TRUE,
    columns = vars(total, confirmed_n, probable_n, suspected_n, not_case_n, unknown_n),
    fns = list('Country Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>%
  grand_summary_rows(
    columns = vars(total, confirmed_n, probable_n, suspected_n, not_case_n, unknown_n),
    fns = list('Grand Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    grand_summary_row.text_transform = 'uppercase',
    data_row.padding = px(1),
    row_group.padding = px(1),
    summary_row.padding = px(1),
    grand_summary_row.padding = px(1))

gtsave(gtbl_sites_covid_status,
       file.path(path.local.msf.tables, glue("gtbl_sites_covid_status_{week_report}.png"))) %>%
  invisible()

gtsave(gtbl_sites_covid_status %>% 
         tab_header(
           title = html(paste('SUMMARY TABLE<br>
           Counts of patients consulted/admitted to an MSF supported COvid-19 health service by Covid status as of', format(date_max_report, "%d %b %Y"))),
    subtitle = 'Sites with (*) reported aggregated data'),
       file.path(path.local.msf.tables, paste0(week_report, '_SUMMARY-TABLE_MSF-sites_by_patients_Covid-status.html'))) %>%
  invisible()


gtbl_sites_covid_status %>% 
  tab_header(
    title = html(paste('SUMMARY TABLE<br>
    Counts of patients consulted/admitted to an MSF supported COvid-19 health service by Covid status as of', format(date_max_report, "%d %b %Y"))),
    subtitle = 'Sites with (*) reported aggregated data') 

```


<!-- 
Table by continent (or region) 

- Proportion of positive tests
- Proportion of suspect cases sent home after screening
- Proportion of asymptomatic among the tested positive
-->
```{r}
# - To be done (FRANCESCO)
# - Priority +
```



### Patients' characteristics

<!-- Table age (median, IQR, min-max), sex and presence of at least one morbidity, by Covid status -->
```{r TblAllGeneralCharacteristics}
# DONE by Francesco

tbl_general <- dta %>% 
  select(covid_status, age_in_years, age_5gp, sex, Comcond_present) %>%
  group_by(covid_status) %>%
  summarise(
    age_total   = paste0(sum(!is.na(age_in_years)) , '/',  n()),  
    age_min_max = paste0(min(age_in_years, na.rm = TRUE), ' - ', max(age_in_years, na.rm = TRUE)),
    age_median  = format(round(median(age_in_years, na.rm = TRUE), digits = 1), nsmall = 1),
    age_gp1     = freq_prct(age_5gp, '0-5'),
    age_gp2     = freq_prct(age_5gp, '5-15'),
    age_gp3     = freq_prct(age_5gp, '15-45'),
    age_gp4     = freq_prct(age_5gp, '45-65'),
    age_gp5     = freq_prct(age_5gp, '65+'),
    sex_total   = paste0(sum(!is.na(sex)) , '/',  n()),
    sex_males   = sum(sex == 'M', na.rm = TRUE),
    sex_females = sum(sex == 'F', na.rm = TRUE),
    sex_ratio   = format(round(sum(sex == 'M', na.rm = TRUE)/sum(sex == 'F', na.rm = TRUE), digits = 1), nsmall = 1),
    comorbidity_total = paste0(sum(!is.na(Comcond_present)) , '/',  n()),
    comorbidity_presence = freq_prct(Comcond_present, 1))


vars_age <- tibble(levels = tbl_general %>% select(starts_with('age_')) %>% names(),
                   labels = c('Totals with age information, n/N', 'Minimum - maximum', 'Median', '0 - 5, n (%)', '5 - 15, n (%)', '15 - 45, n (%)', '45 - 65, n (%)', '65+, n (%)'))

vars_sex <- tibble(levels = tbl_general %>% select(starts_with('sex_')) %>% names(),
                   labels = c('Totals with sex information, n/N', 'Men, n', 'Women, n', 'Sex ratio (M/F)'))

vars_comorbidities <- tibble(levels = tbl_general %>% select(starts_with('comorbidity_')) %>% names(),
                             labels = c('Totals with comorbidity information, n/N', 'Presence of at least one comorbidity, n (%)'))

gtbl_general <- tbl_general %>%
  gather(characteristics, values, -covid_status, factor_key = TRUE) %>%
  spread(covid_status, values) %>%
  mutate(type_characteristic = case_when(
    characteristics ==  'total' ~ NA_character_,
    characteristics %in% vars_age$levels ~ 'Age (in years)',
    characteristics %in% vars_sex$levels ~ 'Sex',
    characteristics %in% vars_comorbidities$levels ~ 'Comorbidities')) %>%
  mutate(
    characteristics = factor(characteristics,
                             levels = c(vars_age$levels, vars_sex$levels, vars_comorbidities$levels),
                             labels = c(vars_age$labels, vars_sex$labels, vars_comorbidities$labels))) %>%
  gt(rowname_col = "characteristics",
     groupname_col = "type_characteristic") %>%
  cols_label(
    characteristics = 'Characteristics') %>%
  cols_align(
    align = 'left',
    columns = vars(characteristics)) %>%
  cols_align(
    align = 'center',
    columns = vars(Confirmed, Probable, Suspected, `Not a case`, `Unknown`)) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_general,
       file.path(path.local.msf.tables, paste0('gtbl_general','_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_general %>% 
         tab_header(
           title = paste('Characteristics of patients consulted in in an MSF supported Covid-19 health service by continent as of', format(date_max_report, "%d %B %Y"))), 
       file.path(path.local.msf.tables, paste0('gtbl_general', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtbl_general %>% 
  tab_header(
    title = paste('Characteristics of patients consulted in an MSF supported Covid-19 health service by continent as of', format(date_max_report, "%d %B %Y")))

```



### Patients' symptoms at consultation/admission

<!-- Table - Frequency and proportion of symptoms by Covid status -->
```{r TblAllSymtopms, layout = "l-body-outset"}
# DONE by Francesco

dta_sympt <- dta %>%
  select(covid_status, tidyselect::vars_select(names(dta), starts_with('symptom_') & !ends_with('_date_onset')))

names_sympt <- grep('^symptom_', names(dta_sympt), perl = TRUE, value = TRUE) %>% sort()

names(names_sympt) <- names_sympt %>%
  gsub('^symptom_','', .) %>%
  gsub('_', ' ', .) %>%
  gsub('anosmia', 'loss of smell', .) %>%
  gsub('loss taste', 'loss of taste', .) %>%
  gsub('sorethoat', 'sorethroat', .) %>%
  stringr::str_to_sentence()

dta_sympt <- rename(dta_sympt, all_of(names_sympt))

for (i in names(names_sympt)) {
  dta_sympt[[i]] <- recode(dta_sympt[[i]], No = 0, Yes = 1, .default = NA_real_)
}

tbl_count <- dta_sympt %>%
  group_by(covid_status) %>%
  summarise_all(~ sum(!is.na(.)), na.rm = TRUE) %>%
  adorn_totals()

tbl_sum <- dta_sympt %>%
  group_by(covid_status) %>%
  summarise_all(~ sum(., na.rm = TRUE)) %>%
  adorn_totals()

tbl_freq <- tibble(covid_status = tbl_sum[[1]])

for(i in names(names_sympt)) {
  tbl_freq[i] <- cbind(paste(tbl_sum[[i]], tbl_count[[i]], sep = '/'))
}

tbl_freq <- tbl_freq %>%
  pivot_longer(-covid_status, names_to = 'symtpoms') %>%
  pivot_wider(names_from = covid_status, values_from = value)

tbl_prop <- tibble(covid_status = tbl_sum[[1]])

for(i in names(names_sympt)) {
  tbl_prop[i] <- cbind(tbl_sum[[i]] / tbl_count[[i]])
}

tbl_prop <- tbl_prop %>%
  pivot_longer(-covid_status, names_to = 'symtpoms') %>%
  pivot_wider(names_from = covid_status, values_from = value)

tbl_sympt <- tbl_freq %>%
  left_join(tbl_prop, by = 'symtpoms', suffix = c(".freq", ".prct")) %>%
  arrange(symtpoms)


gtbl_sympt <- tbl_sympt %>%
  gt() %>%
  cols_label(
    symtpoms = 'Signes/Symptoms',
    Confirmed.freq    = 'n/N',
    Probable.freq     = 'n/N',
    Suspected.freq    = 'n/N',
    `Not a case.freq` = 'n/N',
    Unknown.freq      = 'n/N',
    Total.freq        = 'n/N',
    Confirmed.prct    = '(%)',
    Probable.prct     = '(%)',
    Suspected.prct    = '(%)',
    `Not a case.prct` = '(%)',
     Unknown.prct     = '(%)',  
    Total.prct        = '(%)') %>%
  tab_spanner(
    label = "Confirmed",
    columns = starts_with('Confirmed.')) %>%
  tab_spanner(
    label = "Probable",
    columns = starts_with('Probable.')) %>%
  tab_spanner(
    label = "Suspected",
    columns = starts_with('Suspected.')) %>%
  tab_spanner(
    label = "Not a case",
    columns = starts_with('Not a case.')) %>%
  tab_spanner(
    label = "(Unknown)",
    columns = starts_with('Unknown.')) %>%
  tab_spanner(
    label = "Total",
    columns = starts_with('Total.')) %>%
  fmt_number(
    columns = ends_with('.prct'),
    decimals = 1,
    scale_by = 100,
    pattern = "({x})") %>%
  fmt_missing(
    columns = ends_with('.prct'),
    missing_text = "---") %>%
  cols_align(
    align = 'left',
    columns = vars(symtpoms)) %>%
  cols_align(
    align = 'right',
    columns = ends_with(c('.freq', '.prct'))) %>%
  tab_style(
    style = list(
      cell_text(align = "right")),
    locations = cells_column_labels(columns = ends_with(c('.freq', '.prct')))) %>%
  cols_width(
    vars(symtpoms) ~ px(140),
    ends_with('.freq') ~ px(80),
    ends_with(".prct") ~ px(55)) %>%
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_sympt,
       file.path(path.local.msf.tables, paste0('gtbl_sympt','_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_sympt,
       file.path(path.local.msf.tables, paste0('gtbl_sympt', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_sympt %>% 
  tab_header(
    title = paste('Frequency and proportion symptoms among patients an MSF supported Covid-19 health service by Covid status as of', format(date_max_report, '%d %B %Y')))

```


<!-- Table - Frequency and proportion of patients with at least 1 co-morbidity -->
```{r}
# TO BE DONE by Francesco
```



### Case-fatality by Covid status

<!-- Table Case-fatality risk by Covid status and by continent -->
```{r}
# DONE by Francesco

tbl_cfr_status <- dta %>%
  select(covid_status, outcome_status) %>%
  filter(outcome_status %in% c('Cured', 'Died')) %>%
  group_by(covid_status) %>%
  summarise(
    totals_Total = paste0(sum(outcome_status == 'Died'), '/', n()),
    died_p_Total = mean(outcome_status == 'Died'))


tbl_cfr_status_continent <- dta %>%
  select(continent, covid_status, outcome_status) %>%
  filter(outcome_status %in% c('Cured', 'Died')) %>%
  group_by(continent, covid_status) %>%
  summarise(
    totals = paste0(sum(outcome_status == 'Died'), '/', n()),
    died_p = mean(outcome_status == 'Died')) %>%
  pivot_wider(names_from = continent, values_from = c(totals, died_p))

gtbl_cfr_status_continent <- tbl_cfr_status_continent %>%
  full_join(tbl_cfr_status) %>%
  gt() %>%
  cols_label(
    covid_status     = 'Covid status',
    totals_Africa    = 'n/N',
    totals_Americas  = 'n/N',
    totals_Asia      = 'n/N',
    totals_Total     = 'n/N',
    died_p_Africa    = '(%)',
    died_p_Americas  = '(%)',
    died_p_Asia      = '(%)',
    died_p_Total     = '(%)') %>%
  tab_spanner(
    label = 'Africa',
    columns = ends_with('_Africa')) %>%
  tab_spanner(
    label = 'Americas',
    columns = ends_with('_Americas')) %>%
  tab_spanner(
    label = 'Asia',
    columns = ends_with('_Asia')) %>%
  tab_spanner(
    label = 'Total',
    columns = ends_with('_Total')) %>%
  fmt_number(
    columns = starts_with('died_p_'),
    decimals = 1,
    scale_by = 100,
    pattern = '({x})') %>%
  fmt_missing(
    columns = starts_with('totals_'),
    missing_text = "0/0") %>%
  fmt_missing(
    columns = starts_with('died_p_'),
    missing_text = "---") %>%
  cols_align(
    align = 'left',
    columns = vars(covid_status)) %>%
  cols_align(
    align = 'right',
    columns = starts_with('totals')) %>%
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_cfr_status_continent,
       file.path(path.local.msf.tables, paste0('gtbl_cfr_status_continent','_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_cfr_status_continent,
       file.path(path.local.msf.tables, paste0('gtbl_cfr_status_continent','_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_cfr_status_continent %>% 
  tab_header(
    title = 'Case-fatality risk by Covid status and continent among patients an MSF supported Covid-19 health service', 
    subtitle = 'In the denominator only patients with outcome as cured or died'
  )

```



# Analysis on confirmed patients

### Age and sex distribution of Covid confirmed patients

<!-- Age/sex pyramid -->
```{r, fig.cap = 'Age pyramid of patients consulted/admitted to an MSF supported Covid-19 health service', fig.width = 8, fig.height = 8}
# DONE by Francesco

seq_agegp <- seq(0, 100, 5)

age_labels <- sprintf("%s-%s", seq_agegp[-length(seq_agegp)], seq_agegp[-1] - 1)

dta_age_sex <- dta %>%
  select(continent, region, country, age_in_years, sex) %>%
  mutate(
    age_group = cut(age_in_years, seq_agegp, age_labels, include.lowest = TRUE, right = FALSE),
    sex = factor(sex, levels = c('M','F'), labels = c('Males', 'Females'))) %>%
  filter(!is.na(age_group), !is.na(sex))


caption_graph <- glue::glue('Analysis and graphic by Epicentre | Data source: MSF linelists as of {format(date_max_report, "%d %b %Y")}')

### Pyramid overall
tbl_age_sex <- dta_age_sex %>%
  count(sex, age_group) %>%
  mutate(n = if_else(sex == "Males", -n, n))

n_max <- max(abs(tbl_age_sex$n))
y_breaks <- pretty(0:n_max, n = 6)
y_breaks <- c(-y_breaks, y_breaks)

p_pyramid_age_sex <- ggplot(tbl_age_sex, aes(x = age_group, y = n, fill = sex)) +
  geom_col() +
  coord_flip() +
  scale_fill_brewer("", palette = "Set1", breaks = c("Males", "Females"), labels = c("Males", "Females")) +
  scale_x_discrete("Age groups") +
  scale_y_continuous(name = 'Count', limits = c(-n_max, n_max), label = abs, breaks = y_breaks) +
  theme_light() +
  theme(legend.position = "top") +
  labs(caption = caption_graph)

ggsave(file.path(path.local.msf.graphs, paste0('msf', 'p_pyramid_age_sex', '.png')),
       plot = p_pyramid_age_sex,
       width = 6,
       height = 6)


p_pyramid_age_sex

```


<!-- Age/sex pyramid by continent -->
```{r, eval = FALSE}
# The Pyramid seems not displaying correctly
#p_pyramid_age_sex + facet_wrap(~ region)

```


<!-- 
Table by continent (by region, if possible):
  -	Characteristics: Number and proportion of cases exposed through healthcare facility (healthcare worker + visited)
  -	Characteristics: Number and proportion of cases with chronic diseases (comorbidities)
-->
```{r}
# To think about
```



### Patients care

<!-- 
Table Patient’s care 1
  - Admitted to a hospital/inpatient department,
  - received oxygen,
  - admitted to ICU,
  - supported with ventilator,
  - supported with ECMO
-->
```{r TblCareProcedures}
# DONE by Francesco

dta_care <- dta %>%
  filter(covid_status %in% c('Confirmed')) %>%
  select(continent, country, starts_with('merge_'))

# Correct error on ECMO
dta_care <- dta_care %>%
  mutate(
    merge_ecmo = as.character(merge_ecmo),
    merge_ecmo = case_when(
      merge_ecmo == "Yes" ~ "No at any time",
      TRUE ~ merge_ecmo))

tbl_care <- dta_care %>%
  group_by(continent) %>%
  summarise(
    admit_yes     = freq_prct(merge_admit, 'Yes'),
    admit_no      = freq_prct(merge_admit, 'No'),
    admit_ukn     = freq_prct(merge_admit, 'Unknown'),
    oxygen_yes    = freq_prct(merge_oxygen, 'Yes'),
    oxygen_no_ukn = freq_prct(merge_oxygen, 'No at admission then not reported'),
    oxygen_no     = freq_prct(merge_oxygen, 'No at any time'),
    oxygen_ukn    = freq_prct(merge_oxygen, 'Not reported'),
    icu_yes       = freq_prct(merge_icu, 'Yes'),
    icu_no_ukn    = freq_prct(merge_icu, 'No at admission then not reported'),
    icu_no        = freq_prct(merge_icu, 'No at any time'),
    icu_ukn       = freq_prct(merge_icu, 'Not reported'),
    vent_yes      = freq_prct(merge_vent, 'Yes'),
    vent_no_ukn   = freq_prct(merge_vent, 'No at admission then not reported'),
    vent_no       = freq_prct(merge_vent, 'No at any time'),
    vent_ukn      = freq_prct(merge_vent, 'Not reported'),
    ecmo_yes      = freq_prct(merge_ecmo, 'Yes'),
    ecmo_no_ukn   = freq_prct(merge_ecmo, 'No at admission then not reported'),
    ecmo_no       = freq_prct(merge_ecmo, 'No at any time'),
    ecmo_ukn      = freq_prct(merge_ecmo, 'Not reported'))

tbl_care_total <- dta_care %>%
  summarise(
    admit_yes     = freq_prct(merge_admit, 'Yes'),
    admit_no      = freq_prct(merge_admit, 'No'),
    admit_ukn     = freq_prct(merge_admit, 'Unknown'),
    oxygen_yes    = freq_prct(merge_oxygen, 'Yes'),
    oxygen_no_ukn = freq_prct(merge_oxygen, 'No at admission then not reported'),
    oxygen_no     = freq_prct(merge_oxygen, 'No at any time'),
    oxygen_ukn    = freq_prct(merge_oxygen, 'Not reported'),
    icu_yes       = freq_prct(merge_icu, 'Yes'),
    icu_no_ukn    = freq_prct(merge_icu, 'No at admission then not reported'),
    icu_no        = freq_prct(merge_icu, 'No at any time'),
    icu_ukn       = freq_prct(merge_icu, 'Not reported'),
    vent_yes      = freq_prct(merge_vent, 'Yes'),
    vent_no_ukn   = freq_prct(merge_vent, 'No at admission then not reported'),
    vent_no       = freq_prct(merge_vent, 'No at any time'),
    vent_ukn      = freq_prct(merge_vent, 'Not reported'),
    ecmo_yes      = freq_prct(merge_ecmo, 'Yes'),
    ecmo_no_ukn   = freq_prct(merge_ecmo, 'No at admission then not reported'),
    ecmo_no       = freq_prct(merge_ecmo, 'No at any time'),
    ecmo_ukn      = freq_prct(merge_ecmo, 'Not reported'))

vars_admit <- tibble(levels = tbl_care %>% select(starts_with('admit_')) %>% names(),
                     labels = c('Yes, n (%)', 'No, n (%)', 'Unknow, n (%)'))

labels_care <- c('Yes, n (%)', 'No at admission then not reported, n (%)', 'No at any time, n (%)', 'Not reported, n (%)')

vars_oxigen <- tibble(levels = tbl_care %>% select(starts_with('oxygen_')) %>% names(),
                      labels = labels_care)

vars_icu <- tibble(levels = tbl_care %>% select(starts_with('icu_')) %>% names(),
                   labels = labels_care)


vars_vent <- tibble(levels = tbl_care %>% select(starts_with('vent_')) %>% names(),
                    labels = labels_care)

vars_ecmo <- tibble(levels = tbl_care %>% select(starts_with('ecmo_')) %>% names(),
                    labels = labels_care)


gtbl_care <- tbl_care %>%
  add_row(continent = 'Total', tbl_care_total) %>%
  gather(characteristics, values, -continent, factor_key = TRUE) %>%
  spread(continent, values) %>%
  mutate(
    type_characteristic = case_when(
      characteristics %in% vars_admit$levels  ~ 'Admitted',
      characteristics %in% vars_oxigen$levels ~ 'Received oxygen',
      characteristics %in% vars_icu$levels    ~ 'Admitted to the Intensive Care Unit',
      characteristics %in% vars_vent$levels   ~ 'Supported by a ventilator',
      characteristics %in% vars_ecmo$levels   ~ 'Supported by extracorporeal membrane oxygenation (ECMO)')) %>%
  mutate(
    characteristics = factor(characteristics, levels = c(vars_admit$levels, vars_oxigen$levels, vars_icu$levels, vars_vent$levels, vars_ecmo$levels), labels = c(vars_admit$labels, vars_oxigen$labels, vars_icu$labels, vars_vent$labels, vars_ecmo$labels))) %>%
  gt(rowname_col = "characteristics",
     groupname_col = "type_characteristic") %>%
  tab_spanner(
    label = 'Project location',
    columns = vars(Africa, Americas, Asia)
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(5),
    row_group.padding = px(5))

gtsave(gtbl_care,
       file.path(path.local.msf.tables, paste0('gtbl_care', '_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_care,
       file.path(path.local.msf.tables, paste0('gtbl_care', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_care %>% 
  tab_header(
    title = "Major care procedures to Covid confirmed patient's in MSF heatlth facilities, by location")

```


<!-- Table Patient’s care 2
- medication received (under discussion)
-->
```{r}
# List of medications to be finalised
```




### Age and sex of patients by outcome

```{r}
# DONE by Francesco

dta_age_sex_outcome <- dta %>% 
  select(site_name, covid_status, outcome_status, sex = sex, age_in_years) %>% 
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) 

tbl_age_sex_outcome <- dta_age_sex_outcome %>% 
  group_by(outcome_status) %>% 
  summarise(
    age_median = median(age_in_years, na.rm = TRUE), 
    age_range  = glue('[{min(age_in_years, na.rm = TRUE)} - {max(age_in_years, na.rm = TRUE)}]'), 
    sex_males   = sum(sex == 'M', na.rm = TRUE),
    sex_females = sum(sex == 'F', na.rm = TRUE), 
    sex_ratio   = sex_males/sex_females)

tbl_age_sex_outcome$sex_ratio[is.infinite(tbl_age_sex_outcome$sex_ratio)] <- NA

gtbl_age_sex_outcome <- tbl_age_sex_outcome %>% 
  gt() %>% 
  cols_label(
    outcome_status = 'Status',
    age_median = 'Median', 
    age_range = '[min - max]', 
    sex_males = 'Males', 
    sex_females = 'Females', 
    sex_ratio = 'ratio') %>% 
  fmt_number(
    columns = vars(sex_ratio), 
    decimals = 1) %>% 
  fmt_missing(
    columns = vars(sex_ratio), 
    missing_text = '---') %>% 
  tab_spanner(
    label = 'Age (years)', 
    columns = starts_with('age_')) %>% 
  tab_spanner(
    label = 'Sex', 
    columns = starts_with('sex_')) %>% 
  cols_align(
    align = 'left', 
    columns = vars(outcome_status, age_range)) %>% 
  cols_align(
    align = 'right', 
    columns = starts_with('sex_')) %>% 
  tab_options(
    column_labels.font.weight = "bold", 
    data_row.padding = px(2))

gtsave(gtbl_age_sex_outcome, 
       file.path(path.local.msf.tables, paste0('gtbl_age_sex_outcome', '_', week_report, '.png'))) %>% 
  invisible()

gtsave(gtbl_age_sex_outcome, 
       file.path(path.local.msf.tables, paste0('gtbl_age_sex_outcome', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtbl_age_sex_outcome %>% 
  tab_header(
    title = 'Age and sex ditribution by type of patient outcome among confirmed, probable and suspected Covid cases')

```





### Case fatality risk among confirmed patients

<!-- Table Outcome 1 - Case Fatality Risk by continent -->
<!-- CFR by region or country of not too long -->
```{r}
# DONE by Francesco

tbl_cfr_age <- dta %>% 
  filter(covid_status == 'Confirmed', outcome_status %in% c('Cured', 'Died'), !is.na(age_5gp)) %>% 
  select(age_5gp, outcome_status) %>% 
  group_by(age_5gp) %>% 
  summarise(
    total  = n(), 
    cured_n = sum(outcome_status == 'Cured'), 
    cured_p = mean(outcome_status == 'Cured'), 
    died_n = sum(outcome_status == 'Died'), 
    died_p = mean(outcome_status == 'Died')
  ) %>% 
  mutate(
    type_var = 'Age'
  )

tbl_cfr_sex <- dta %>% 
  filter(covid_status == 'Confirmed', outcome_status %in% c('Cured', 'Died'), !is.na(sex)) %>% 
  mutate(sex = factor(sex, levels = c('F', 'M'), labels = c('Females', 'Males'))) %>% 
  select(sex, outcome_status) %>% 
  group_by(sex) %>% 
  summarise(
    total  = n(), 
    cured_n = sum(outcome_status == 'Cured'), 
    cured_p = mean(outcome_status == 'Cured'), 
    died_n = sum(outcome_status == 'Died'), 
    died_p = mean(outcome_status == 'Died')
  ) %>% 
  mutate(
    type_var = 'Sex'
  )

tbl_cfr_comorb <- dta %>% 
  filter(covid_status == 'Confirmed', outcome_status %in% c('Cured', 'Died'), !is.na(Comcond_present)) %>% 
  select(Comcond_present, outcome_status) %>% 
  mutate(Comcond_present = as.character(Comcond_present)) %>% 
  group_by(Comcond_present) %>% 
  summarise(
    total  = n(), 
    cured_n = sum(outcome_status == 'Cured'), 
    cured_p = mean(outcome_status == 'Cured'), 
    died_n = sum(outcome_status == 'Died'), 
    died_p = mean(outcome_status == 'Died')
  ) %>% 
  mutate(
    type_var = 'Number of comorbidities'
  )

tbl_cfr_factors_1 <- tbl_cfr_age %>% rename(var = age_5gp) %>% 
  add_row(tbl_cfr_sex %>% rename(var = sex)) %>% 
  add_row(tbl_cfr_comorb %>% rename(var = Comcond_present))

gtbl_cfr_factors_1 <- tbl_cfr_factors_1 %>% 
  gt(rowname_col = "var", 
     groupname_col = "type_var") %>% 
  cols_label(
    total = html('Total'), 
    cured_n = 'n', 
    cured_p = '%', 
    died_n = 'n', 
    died_p = '%') %>% 
  tab_spanner(
    label = 'Cured', 
    columns = starts_with('cured_')) %>% 
  tab_spanner(
    label = 'Died', 
    columns = starts_with('died_')) %>% 
  fmt_number(
    columns = vars(cured_p, died_p), 
    decimals = 1, 
    scale_by = 100) %>% 
  fmt_missing(
    columns = vars(cured_p, died_p), 
    missing_text = '---') %>% 
  cols_align(
    align = 'right', 
    columns = vars(total, cured_n, died_n, cured_p, died_p)) %>% 
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = 'bold', 
    data_row.padding = px(2))

gtsave(gtbl_cfr_factors_1, 
       file.path(path.local.msf.tables, glue('gtbl_cfr_factors_1', '_', week_report, '.png'))) %>% 
  invisible()


gtsave(gtbl_cfr_factors_1, 
       file.path(path.local.msf.tables, paste0('gtbl_cfr_factors_1', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtbl_cfr_factors_1 %>% 
  tab_header(
    title = 'Case fatality risk by age, sex and number of comorbidities'
  )

```



<!-- 
Table Outcome 2 - Count of cured, deaths, transferred… by Admitted/Not Admitted
This table is NOT used any more 
-->
```{r, eval = FALSE}
# DONE by Francesco

dta_outcome <- dta %>%
  select(covid_status, merge_admit, tidyselect::vars_select(names(dta), starts_with('outcome_')))

tbl_outcome <- dta_outcome %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  count(merge_admit, outcome_status, .drop = FALSE) %>%
  pivot_wider(names_from = merge_admit, values_from = n, values_fill = list(n = 0)) %>%
  adorn_totals('col') %>%
  mutate(
    prct_yes = round(Yes / sum(Yes) * 100, 1),
    prct_no  = round(No / sum(No) * 100, 1),
    prct_ukn = round(Unknown / sum(Unknown) * 100, 1),
    prct_tot = round(Total / sum(Total) * 100, 1)) %>%
  adorn_totals('row')

gtbl_outcome <- tbl_outcome %>%
  gt() %>%
  cols_label(
    outcome_status = 'Status',
    Yes = 'N',
    prct_yes = '(%)',
    No = 'N',
    prct_no = '(%)',
    Unknown = 'N',
    prct_ukn = '(%)',
    Total = 'N',
    prct_tot = '(%)') %>%
  tab_spanner(
    label = "Admitted",
    columns = vars(Yes, prct_yes)) %>%
  tab_spanner(
    label = "Non admitted",
    columns = vars(No, prct_no)) %>%
  tab_spanner(
    label = "Unknown",
    columns = vars(Unknown, prct_ukn)) %>%
  tab_spanner(
    label = "Total",
    columns = vars(Total, prct_tot)) %>%
  fmt_missing(
    columns = starts_with('prct_'),
   missing_text = "--") %>%
  text_transform(
    locations = cells_body(
      columns = starts_with('prct_')),
    fn = function(x) {
        x = paste0('(',x,')')}) %>%
  text_transform(
    locations = cells_body(
      columns = starts_with('prct_'),
      rows = outcome_status == 'Total'),
    fn = function(x) {
        x = '---'}) %>%
  cols_align(
    align = 'right',
    columns = vars(Yes, No, Unknown, Total)) %>%
  cols_align(
    align = 'right',
    columns = starts_with('prct_')) %>%
  tab_style(
    style = list(
      cell_text(align = "right")),
    locations = cells_column_labels(columns = vars(Yes, No, Unknown, Total))) %>%
  tab_style(
    style = list(
      cell_text(align = "right")),
    locations = cells_column_labels(columns = starts_with('prct_'))) %>%
  cols_width(
    vars(outcome_status) ~ px(210),
    vars(Yes, No, Unknown , Total) ~ px(70),
    starts_with("prct_") ~ px(50)) %>%
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(2))

gtsave(gtbl_outcome,
       file.path(path.local.msf.tables, paste0('gtbl_outcome', '_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_outcome,
       file.path(path.local.msf.tables, paste0('gtbl_outcome', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_outcome %>% 
  tab_header(
    title = 'Count of pateints outcome by Admitted/Not Admitted'
  )

```



### Comorbidities and Underlying conditions
<!-- 
Table not present in the original analysis plan
  - Frequency of co-morbidities, among cured and deaths
Consider to stratify by continent 
-->
```{r}
# DONE by Francesco

dta_comcond <- dta %>%
  select(covid_status, outcome_status, starts_with('Comcond_'), hiv_status, hypertension , tb_active, malaria, malnutrition, smoking) %>%
  filter(covid_status == 'Confirmed', outcome_status %in% c('Cured', 'Died')) %>% 
  mutate(
    malaria = case_when(
      malaria %in% c('Inconclusive', 'Not done') ~ 'Unknown', 
      malaria == 'Positive' ~ 'Yes', 
      malaria == 'Negative' ~ 'No',
      TRUE ~ malaria), 
    hiv_status = case_when(
      hiv_status %in% c('Positive (on ARV)', 'Positive (unknown)') ~ 'Yes', 
      hiv_status == 'Negative' ~ 'No',
      TRUE ~ hiv_status), 
    tb_active = case_when(
      tb_active %in% c('Yes (currently no treatment)', 'Yes (currently on treatment)', 'Yes (unknown)') ~ 'Yes', 
      TRUE ~ tb_active), 
    smoking = case_when(
      smoking %in% c('Yes (current)', 'Yes (former)') ~ 'Yes', 
      TRUE ~ smoking)) %>% 
  select(-c(Comcond_present, Comcond_pregt)) %>% 
  pivot_longer(-c(covid_status,outcome_status), names_to = "type_comorbidity") %>%
  filter(!is.na(value), value == 'Yes')

levels_comcond <- c('Comcond_cardi', 'Comcond_immuno', 'Comcond_renal', 'Comcond_liver', 'Comcond_neuro', 'Comcond_diabetes', 'Comcond_lung', 'Comcond_preg', 'Comcond_malig', 'hypertension', 'hiv_status', 'tb_active', 'malaria', 'smoking')
labels_comcond <- c('Cardiovascular (including hypertention)', 'Immunological (including HIV)', 'Renal', 'Hepatic', 'Neurological', 'Diabetes', 'Respiratory (including chronic lung diseases)', 'Pregnancy', 'Cancer', 'Hypertension', 'HIV', 'TB', 'Malaria', 'Smoking')

dta_comcond <- dta_comcond %>%
  mutate(
    type_comorbidity = factor(type_comorbidity, levels = levels_comcond, labels = labels_comcond)
)

tbl_risk_comcond <- dta_comcond %>%
  group_by(type_comorbidity) %>%
  summarise(total = n(),
            cured_n = sum(outcome_status == 'Cured', na.rm = TRUE),
            died_n  = sum(outcome_status == 'Died', na.rm = TRUE),
            cured_p = mean(outcome_status == 'Cured', na.rm = TRUE),
            died_p  = mean(outcome_status == 'Died', na.rm = TRUE))

gtbl_risk_comcond <- tbl_risk_comcond %>%
  gt() %>%
  cols_label(
    type_comorbidity = "Comorbidities/Underlying conditions",
    total = html('Total'),
    cured_n = 'n',
    cured_p = '%',
    died_n = 'n',
    died_p = '%') %>%
  tab_spanner(
    label = 'Cured',
    columns = starts_with('cured_')) %>%
  tab_spanner(
    label = 'Died',
    columns = starts_with('died_')) %>%
  fmt_number(
    columns = vars(cured_p, died_p),
    decimals = 1,
    scale_by = 100) %>%
  fmt_missing(
    columns = vars(cured_p, died_p),
    missing_text = '---') %>%
  cols_align(
    align = 'right',
    columns = vars(total, cured_n, died_n, cured_p, died_p)) %>%
    cols_align(
    align = 'left',
    columns = vars(type_comorbidity)) %>%
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(2))

gtsave(gtbl_risk_comcond,
       file.path(path.local.msf.tables, paste0('gtbl_risk_comcond', '_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_risk_comcond,
       file.path(path.local.msf.tables, paste0('gtbl_risk_comcond', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_risk_comcond %>% 
  tab_header(
    title = 'Frequency and percentage of comorbidities among cured and dead confirmed patients'
  )

```


<!-- Table Outcome 2 - Hospital case fatality risk** by continent (region ??)
  - overall
  - by age group
  - by sex
  - by co-morbidity
-->
```{r}
# DONE????
```


<!-- Table Patients' characteristics
Frequency and proportion of symptoms, by case severity
-->
```{r}
# TO BE DONE as soon as the proper definition of severity is available
```



# Evolution overtime of the following indicators among the Covid19 confirmed cases

### Outcome by epiweek with CFR

<!--
**With all confirmed cases as denominator: time-series and trends plot** with week as time unit of the following indicator:

Time-series plot:
  -	Proportion of admitted over the confirmed - line
  -	Proportion of patients with severe symptoms - line
  -	Delay from symptoms onset to consultation/admission - boxplot
  -	Length of staying for patients hospitalised - boxplot
  -	Case fatality risk for patients hospitalised - line
-->
```{r BoxPlotCFR, fig.cap = 'Evolution overtime of the case fatality risk among Covid confirmed patients consulted/admitted to an MSF supported health facility'}
# DONE by Paul
# Only including outcomes of cured or died as CFR denominator - is this ok? FG: Yes

# 2 most recent epi weeks to remove from chart
latest_2_epi_weeks <- max_2(dta$epi_week_consultation)

df_deaths_epiweek_prop <- dta %>%
  filter(
    covid_status %in% c("Confirmed", "Suspected", "Probable"),
    outcome_status %in% c("Cured", "Died"),
    !epi_week_consultation %in% latest_2_epi_weeks
  ) %>%
  drop_na(epi_week_consultation) %>%
  group_by(epi_week_consultation) %>%
  summarise(
    total = sum(!is.na(outcome_status)),
    dead = sum(outcome_status == "Died", na.rm = T),
    prop_dead = (dead / total) #* 100
  ) %>%
  ungroup()

df_deaths_epiweek <- dta %>%
  filter(
    covid_status %in% c("Confirmed", "Suspected", "Probable"),
    outcome_status %in% c("Cured", "Died"),
    !epi_week_consultation %in% latest_2_epi_weeks
  ) %>%
  count(epi_week_consultation, outcome_status) %>%
  drop_na() %>%
  ungroup()

n_max <- max(df_deaths_epiweek_prop$total, na.rm = TRUE)
cfr_max <- rounder(max(df_deaths_epiweek_prop$prop_dead, na.rm = TRUE), .1)
scaling_factor <- cfr_max / n_max # sets the y limit of CFR rounded up to nearest 10% above cfr max

p_outcome_cfr <- ggplot(df_deaths_epiweek, aes(epi_week_consultation, n)) +
  geom_col(aes(fill = outcome_status)) +
  geom_line(data = df_deaths_epiweek_prop,
            aes(y = prop_dead / scaling_factor, colour = "CFR"),
            key_glyph = "timeseries", size = 1) +
  scale_x_date(name = "Week of Admission", date_breaks = "1 week", date_labels = "%V", sec.axis = ggplot2::sec_axis(trans = ~ .)) + #, labels = function(x) format(x, "%b-%Y")
  scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . * scaling_factor, name = "Case Fatality Rate", labels = scales::percent_format(accuracy = 1))) +
  ggthemes::scale_fill_tableau() +
  labs(y = "Patients", colour = NULL, fill = "Outcome", caption = "Latest 2 weeks omitted for data completeness purposes") +
  theme(legend.position = "top")

ggsave(file.path(path.local.msf.graphs, glue("msf_outcome_cfr_{week_report}.png")),
       plot = p_outcome_cfr,
       scale = 1.1,
       dpi = 320)

p_outcome_cfr

```


### Outcome by epiweek with CFR by continent

```{r BoxPlotCFRContinent, fig.cap = 'Evolution overtime of the case fatality risk among Covid confirmed patients consulted/admitted to an MSF supported health facility, separated by continent'}
# DONE by Paul
# Only including outcomes of cured or died as CFR denominator - is this ok? FG: Yes

# 2 most recent epi-weeks to remove from chart
latest_2_epi_weeks <- max_2(dta$epi_week_consultation)

df_deaths_epiweek_continent_prop <- dta %>%
  filter(
    covid_status %in% c("Confirmed", "Suspected", "Probable"),
    outcome_status %in% c("Cured", "Died"),
    !epi_week_consultation %in% latest_2_epi_weeks
  ) %>%
  group_by(continent, epi_week_consultation) %>%
  summarise(
    total = sum(!is.na(outcome_status)),
    dead = sum(outcome_status == "Died", na.rm = T),
    prop_dead = (dead / total) #* 100
  ) %>%
  ungroup()

df_deaths_epiweek_continent <- dta %>%
  filter(
    covid_status %in% c("Confirmed", "Suspected", "Probable"),
    outcome_status %in% c("Cured", "Died"),
    !epi_week_consultation %in% latest_2_epi_weeks
  ) %>%
  count(continent, epi_week_consultation, outcome_status) %>%
  drop_na()

n_max <- max(df_deaths_epiweek_continent_prop$total, na.rm = TRUE)
cfr_max <- rounder(max(df_deaths_epiweek_continent_prop$prop_dead, na.rm = TRUE), .1)
cfr_max <- ifelse(cfr_max > 1, 1, cfr_max)
scaling_factor <- cfr_max / n_max # sets the y limit of CFR rounded up to nearest 10% above cfr max

p_outcome_cfr_continent <- ggplot(df_deaths_epiweek_continent, aes(epi_week_consultation, n)) +
  facet_wrap(~continent, ncol = 1) +
  geom_col(aes(fill = outcome_status)) +
  geom_line(data = df_deaths_epiweek_continent_prop,
            aes(y = prop_dead / scaling_factor, colour = "CFR"),
            key_glyph = "timeseries", size = 1) +
  scale_x_date(name = "Week of Admission", date_breaks = "1 week", date_labels = "%V", sec.axis = ggplot2::sec_axis(trans = ~ .)) + #, labels = function(x) format(x, "%b-%Y")
  scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . * scaling_factor, name = "Case Fatality Rate", labels = scales::percent_format(accuracy = 1))) +
  ggthemes::scale_fill_tableau() +
  labs(y = "Patients", colour = NULL, fill = "Outcome", caption = "Latest 2 weeks omitted for data completeness purposes") +
  theme(legend.position = "top")

ggsave(file.path(path.local.msf.graphs, glue("msf_outcome_cfr_continent_{week_report}.png")),
       plot = p_outcome_cfr_continent,
       scale = 1,
       dpi = 320)

p_outcome_cfr_continent

```


### Onset to admission delay

```{r BoxPlotDelayAdmission, fig.cap = 'Evolution overtime of the delay to admission among Covid confirmed patients consulted/admitted to an MSF supported health facility'}
# DONE by Paul

# onset admission delay
# p_onset_admit_delay <- dta %>%
#   filter(covid_status %in% c("Confirmed", "Suspected", "Probable")) %>%
#   drop_na(epi_week_consultation, delay_before_admission) %>%
#   group_by(epi_week_consultation) %>%
#   summarise(
#     lower_2_5 = quantile(delay_before_admission, 0.025),
#     lower_25 = quantile(delay_before_admission, 0.25),
#     median = median(delay_before_admission),
#     upper_75 = quantile(delay_before_admission, 0.55),
#     upper_97_5 = quantile(delay_before_admission, 0.975)
#   ) %>%
#   ungroup() %>%
#   slice(1:(n()-1)) %>%
#   ggplot(aes(epi_week_consultation, median)) +
#   geom_linerange(aes(ymin = lower_2_5, ymax = upper_97_5)) +
#   geom_point(colour = "red", size = 3) +
#   scale_x_date(name = "Week of Consultation", date_breaks = "1 week", date_labels = "%V",
#                sec.axis = ggplot2::sec_axis(trans = ~ as.Date(.), labels = function(x) format(x, "%b-%Y")))

p_onset_admit_delay <- dta %>%
  filter(covid_status %in% c("Confirmed", "Suspected", "Probable")) %>%
  drop_na(epi_week_consultation, delay_before_admission) %>%
  filter(delay_before_admission <= 50) %>% # filter any delays over 50 days
  filter(epi_week_consultation != max(epi_week_consultation)) %>%  # there's an incorrect this week in week 25 so remove (delete this line next week)
  ggplot(aes(epi_week_consultation, delay_before_admission, group = epi_week_consultation)) +
  #geom_jitter(colour = "red", alpha = 0.5) +
  geom_boxplot() +
  scale_x_date(name = "Week of Consultation", date_breaks = "1 week", date_labels = "%V", sec.axis = ggplot2::sec_axis(trans = ~ .)) +
  labs(y = "Onset to admission delay (days)")

ggsave(file.path(path.local.msf.graphs, glue("msf_onset_admit_delay_{week_report}.png")),
       plot = p_onset_admit_delay,
       scale = 1,
       dpi = 320)

p_onset_admit_delay

```


### Length of stay in hospital

```{r BoxPlotLengthStay, fig.cap = 'Evolution overtime of of length of stay among Covid confirmed hospitalized patients in an MSF supported health facility'}
# DONE by Paul

# 2 most recent epi weeks to remove from chart
latest_2_epi_weeks <- max_2(dta$epi_week_consultation)

# length stay
p_length_stay <- dta %>%
  filter(covid_status %in% c("Confirmed", "Suspected", "Probable")) %>%
  drop_na(epi_week_consultation, length_stay) %>%
  filter(length_stay <= 50, !epi_week_consultation %in% latest_2_epi_weeks) %>% # filter any stays over 50 days
  ggplot(aes(epi_week_consultation, length_stay, group = epi_week_consultation)) +
  #geom_jitter(colour = "red", alpha = 0.3) +
  geom_boxplot() +
  scale_x_date(name = "Week of Admission", date_breaks = "1 week", date_labels = "%V", sec.axis = ggplot2::sec_axis(trans = ~ .)) +
  labs(y = "Length of stay in hospital (days)", caption = "Latest 2 weeks omitted for data completeness purposes")

ggsave(file.path(path.local.msf.graphs, glue("msf_length_stay_{week_report}.png")),
       plot = p_length_stay,
       scale = 1,
       dpi = 320)

p_length_stay

```


<!-- 
**With all confirmed cases with severe or critical symptoms as denominator: time-series and trends plot** with week as time unit of the following indicator:

  -	Proportion of patients who received oxygen
  -	Proportion of patients admitted to ICU
  -	Proportion of patients supported by ventilator
  -	Proportion of patients supported by ECMO
-->
```{r}
# TO BE DONE as soon as patients are properly classified by severity
```



<!-- Save results -->
```{r save_results}

rm(list = lsf.str())
save.image(file.path(path.local.msf.data, paste0('episitrep_msf_level_analyses', '_', week_report, '.RData')))

```
